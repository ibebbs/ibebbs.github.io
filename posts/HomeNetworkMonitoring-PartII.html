

<!DOCTYPE html>
<html lang="en">
        <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>

        <title>Ian Bebbington - Home Network Monitoring - Part II</title>
        <meta name="description" content="IObservable&lt;Opinion&gt;" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link type="application/rss+xml" rel="alternate" title="Ian Bebbington" href="/feed.rss" />
        <link type="application/atom+xml" rel="alternate" title="Ian Bebbington" href="/feed.atom" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">

        <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet" />
        <link href="/assets/css/prettify.css" rel="stylesheet">
        <link href="/assets/css/github.css" rel="stylesheet">
        <link href="/assets/css/clean-blog.css" rel="stylesheet" />
        <link href="/assets/css/master.css" rel="stylesheet" />
        <link href="/assets/css/custom.css" rel="stylesheet" />
        <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>


        <meta name="application-name" content="Ian Bebbington" />
        <meta name="msapplication-tooltip" content="Ian Bebbington" />
        <meta name="msapplication-starturl" content="/" />

        <meta property="og:title" content="Ian Bebbington - Home Network Monitoring - Part II" />
        
        <meta property="og:type" content="website" />
        <meta property="og:url" content="http://ian.bebbs.co.uk/posts/HomeNetworkMonitoring-PartII" />
        <!-- TODO: More social graph meta tags -->

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
        <script src="/assets/js/prettify.js"></script>
        <script src="/assets/js/clean-blog.js"></script>
        <script src="http://d3js.org/d3.v3.min.js"></script>
        <script src="/assets/js/trianglify.min.js"></script>
        <script src="/assets/js/Please-compressed.js"></script>

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        </head>
        <body onload="prettyPrint()">

                <!-- Navigation -->
                <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
                        <div class="container-fluid">
                                <!-- Brand and toggle get grouped for better mobile display -->
                                <div class="navbar-header page-scroll">
                                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
                                        <span class="sr-only">Toggle navigation</span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        </button>
                                        <a class="navbar-brand" href="/">Ian Bebbington</a>
                                </div>

                                <!-- Collect the nav links, forms, and other content for toggling -->
                                <div class="collapse navbar-collapse" id="navbar-collapse">
                                        <ul class="nav navbar-nav navbar-right">
                                                        <li><a href="/about">About Me</a></li>
        <li><a href="/tags">All Tags</a></li>
        <li><a href="/posts">Archive</a></li>

                                        </ul>
                                </div>
                                <!-- /.navbar-collapse -->
                        </div>
                        <!-- /.container -->
                </nav>

                <!-- Page Header -->

                <header class="intro-header" id="intro-header">
                        <div class="container">
                                <div class="row">
                                        <div class="col-md-12">

    

<div class="post-heading">
    <h1>Home Network Monitoring - Part II</h1>
        <h2 class="subheading">Using free and open-source tools to monitor my home network</h2>
    <div class="meta">        
            Published on 10 April 2016<br>
    </div>
        <div class="tags">
                    <a role="button" href="/tags/elastic-stack" class="btn btn-default btn-xs">Elastic Stack</a>
                    <a role="button" href="/tags/elasticsearch" class="btn btn-default btn-xs">ElasticSearch</a>
                    <a role="button" href="/tags/kibana" class="btn btn-default btn-xs">Kibana</a>
                    <a role="button" href="/tags/logstash" class="btn btn-default btn-xs">LogStash</a>
                    <a role="button" href="/tags/monitoring" class="btn btn-default btn-xs">Monitoring</a>
                    <a role="button" href="/tags/networking" class="btn btn-default btn-xs">Networking</a>
                    <a role="button" href="/tags/syslog" class="btn btn-default btn-xs">Syslog</a>
        </div>     
</div>
                                        </div>
                                </div>
                        </div>
                </header>

                <!-- Main Content -->
                <div class="container">
                        <div class="row">
                                <div id="content" class="col-md-12">
                                        


<p>In part one of this series I set up my home router to send a variety of Syslog messages to LogStash which then forwarded these messages to ElasticSearch for indexing and querying by Kibana in a simplistic dashboard. In this post, I'm going to start parsing out some of the details of the Syslog messages to start giving us a clearer idea about which devices on my local network are opening sessions with remote servers.</p>
<h1>message types</h1>
<p>My router sends a number of different messages types; everything from router/dsl bandwidth information to the firewall log as can be seen below:</p>
<img src="/Content/HomeNetworkMonitoring/DrayTek-Syslog.png" class="img-responsive" style="margin: auto; width:600px; margin-top: 6px; margin-bottom: 6px;" alt="DrayTek Syslog Administration">
<p>For now, I'm really only interested in the 'User Access Log' which tells us when a local device resolves an IP address for a domain name or accesses a remote server. This log constitutes a number of message types such as:</p>
<ol>
<li><p>TCP / UDP access
This message is sent by the router when a device on the local network accesses a remote server via TCP or UDP. It looks like this: <code>&lt;150&gt;Apr 10 16:55:38 Vigor: Local User (MAC=00-00-00-00-00-00): 192.168.1.205:64281 -&gt; 5.10.110.36:80 (TCP)Web</code>. From this type of message I am interested in parsing out:</p>
<ul>
<li>Syslog timestamp</li>
<li>Syslog username</li>
<li>Source Mac Address</li>
<li>Source IP Address</li>
<li>Destination IP Address</li>
<li>Protocol</li>
</ul>
</li>
<li><p>DNS lookup
This message is sent by the router when a device on the local network resolves an IP address for a remote server DNS nane. It looks like this: <code>&lt;150&gt;Apr 10 18:52:49 Vigor: Local User (MAC=00-00-00-00-00-00): 192.168.1.62 DNS -&gt; 192.168.1.1 inquire a.root-servers.net</code>. From this type of message I am interested in parsing out:</p>
<ul>
<li>Syslog timestamp</li>
<li>Syslog username</li>
<li>Source Mac Address</li>
<li>Source IP Address</li>
<li>Domain being resolved</li>
</ul>
</li>
</ol>
<p>In this post I'll focus on enriching the incoming message with information from the access message but will move on to parsing multiple message types in a future post.</p>
<h1>parsing access messages</h1>
<p>Logstash provides a great tool for parsing messages: the 'grok' filter. As explained in <a href="https://www.elastic.co/guide/en/logstash/current/plugins-filters-grok.html">the documentation</a> 'grok' allows you to 'Parse arbitrary text and structure it. This tool is perfect for syslog logs, apache and other webserver logs, mysql logs, and in general, any log format that is generally written for humans and not computer consumption.'</p>
<p>This filter applies a regular expression like patterns to a field in the incoming message and, if matched successfully, adds each matched expression to the message being processed as a new field. The fields to capture are defined in the format <code>%{SYNTAX:SEMANTIC}</code> where the <code>SYNTAX</code> element is a known pattern (see below) or a regular expression and the <code>SEMANTIC</code> is a name of the field to capture.</p>
<p>Logstash ships with over 120 known <code>SYNTAX</code> patterns and these patterns can be supplemented by adding new pattern files to a specific directory. However, the default patterns supplied cover nearly all common scenarios and allow almost all the pertinent information in the TCP access message above to be parsed.</p>
<p>So, by just using the default patterns, I can write the expression</p>
<pre class="prettyprint"><code>&lt;%{POSINT:syslog_pri}&gt;%{SYSLOGTIMESTAMP:syslog_timestamp} Vigor\: Local User \(MAC=%{MAC:source_mac}\): %{IP:source_address}(?::%{POSINT:source_port})? -&gt; %{IP:destination_address}(?::%{POSINT:destination_port})?
</code></pre>
<p>Which gives us the following additional fields in the message:</p>
<p>|field|value|
|-----|-----|
|source_address|192.168.1.205|
|source_port|64281|
|source_mac|00-00-00-00-00-00|
|syslog_pri|150|
|syslog_timestamp|Apr·10·16:55:38|
|destination_address|5.10.110.36|
|destination_port|80|</p>
<p>Neat huh! I'd also like to know whether the access message is TCP or UDP so I'm going to add a custom regular expression to the end of the pattern to parse the protocol string out of the message. In full the pattern is now:</p>
<pre class="prettyprint"><code>&lt;%{POSINT:syslog_pri}&gt;%{SYSLOGTIMESTAMP:syslog_timestamp} Vigor\: Local User \(MAC=%{MAC:source_mac}\): %{IP:source_address}(?::%{POSINT:source_port})? -&gt; %{IP:destination_address}(?::%{POSINT:destination_port})? \((?&lt;protocol&gt;TCP|UDP)\)
</code></pre>
<p>This would result in the following fields available in the message:</p>
<p>|field|value|
|-----|-----|
|source_address|192.168.1.205|
|source_port|64281|
|source_mac|00-00-00-00-00-00|
|syslog_pri|150|
|syslog_timestamp|Apr·10·16:55:38|
|destination_address|5.10.110.36|
|destination_port|80|
|<strong>protocol</strong>|<strong>TCP</strong>|</p>
<blockquote>
<p>NOTE: You can use <a href="http://grokconstructor.appspot.com/">Grok Constructor</a> to help you perfect your grok expressions prior to trying them in Logstash</p>
</blockquote>
<h1>adding the grok filter to logstash</h1>
<p>So, now I know how to extract all the information I'm interested in from the access message, I need to get Logstash to actually do it. This is done by adding a <code>grok</code> filter to the <code>filter { }</code> section of the <code>syslog.config</code> file authored in the previous post as shown here:</p>
<pre class="prettyprint"><code>input {
  tcp {
    port =&gt; 5000
    type =&gt; syslog
  }
  udp {
    port =&gt; 5000
    type =&gt; syslog
  }
}

filter {
    grok {
      match =&gt; [ &quot;message&quot;, &quot;&lt;%{POSINT:syslog_pri}&gt;%{SYSLOGTIMESTAMP:syslog_timestamp} Vigor\: Local User \(MAC=%{MAC:source_mac}\): %{IP:source_address}(?::%{POSINT:source_port})? -&gt; %{IP:destination_address}(?::%{POSINT:destination_port})? \((?&lt;protocol&gt;TCP|UDP)\)&quot; ]
    }
}

output {
  elasticsearch {
    hosts =&gt; [&quot;192.168.1.30:9200&quot;]
    index =&gt; &quot;syslog-%{+YYYY.MM.dd}&quot;
  }
}
</code></pre>
<p>Notice the grok section in which we specify a 'match' field. This field takes an array of two strings; the first string is the field containing the text to match and the second is the pattern to match the text to.</p>
<p>Once this is added to the <code>syslog.config</code> file and Logstash restarted, these new fields should be being written to ElasticSearch. The easiest way to see if this is working is to return to Kibana and, from the 'Settings/Indices' area, click the 'syslog-*' pattern on the left and then click the orange 'Refresh field list' button and the field list appears like this:</p>
<img src="/Content/HomeNetworkMonitoring/Kibana-RefreshSyslogIndex.png" class="img-responsive" style="margin: auto; width:600px; margin-top: 6px; margin-bottom: 6px;" alt="Kibana Refresh Syslog Index">
<h1>exploring network access information</h1>
<p>Now the additional fields are available to Kibana, I can start exploring the data to learn about which devices on my network are access which remote servers.</p>
<p>To do this I first need to add the new fields to the 'Syslog Messages' saved search. This can be done by navigating to the 'Discover' page, loading the 'Syslog Messages' search (using the 'Load Saved Search' button in the top right of the screen), adding the new fields and re-saving it. This is shown below:</p>
<img src="/Content/HomeNetworkMonitoring/Kibana-AddingNewFieldsToSyslogMessagesSavedSearch.png" class="img-responsive" style="margin: auto; width:600px; margin-top: 6px; margin-bottom: 6px;" alt="Kibana Adding New Fields To Syslog Messages Saved Search">
<p>I'm now able to add some very interesting new visualizations to our dashboard such as:</p>
<ul>
<li>Number of access by each local device</li>
<li>Number of access by port</li>
<li>Number of access to each remote server</li>
<li>Number of access by protocol</li>
</ul>
<p>I'll only run through adding the first visualization is they're all very similar.</p>
<p>First, I navigate to the 'Visualization' area and click the 'New Visualization' button. I want to see the number of accesses being made by each device as a fraction of the whole so will use a donut chart. This is done by selecting 'Pie chart' from the &quot;Create new Visualization&quot; menu and selecting our 'Syslog Messages' saved search in the &quot;Select a search source&quot; menu. Once this is done, I get a pie chart with a single section as shown here:</p>
<img src="/Content/HomeNetworkMonitoring/Kibana-NewPieChartVisualization.png" class="img-responsive" style="margin: auto; width:600px; margin-top: 6px; margin-bottom: 6px;" alt="Kibana New Pie Chart Visualization">
<p>I then need to select the 'Split Slices' bucket type, choose 'Terms' as the aggregation type and finally select 'source_address' as the field on which to aggregate (i.e. count) unique terms. Applying this to the pie-chart (using the 'Apply' button) results in the following:</p>
<img src="/Content/HomeNetworkMonitoring/Kibana-SplitSlicePieChartUsingSourceAddress.png" class="img-responsive" style="margin: auto; width:600px; margin-top: 6px; margin-bottom: 6px;" alt="Kibana Split Slice Pie Chart Using Source  ddres s">
<p>I'll  then  turn  this into a donut chart by ticking the 'Donut' check box from the 'Options' area as shown below:</p>
<img src="/Content/HomeNetworkMonitoring/Kibana-SplitSliceDonutChartUsingSourceAddress.png" class="img-responsive" style="margin: auto; width:600px; margin-top: 6px; margin-bottom: 6px;" alt="Kibana Split Slice Donut Chart Using Source Address">
<p>Now I'll use the same process for adding donut charts for each of the other metrics outlined above and add all the charts to my dashboard giving me the following:</p>
<img src="/Content/HomeNetworkMonitoring/Kibana-DashboardWithAccessCharts.png" class="img-responsive" style="margin: auto; width:600px; margin-top: 6px; margin-bottom: 6px;" alt="Kibana Dashboard With Access Charts">
<h1>summary</h1>
<p>In this post, I showed how to extract structured information from unstructured text data in our source message. I then showed how this can be used within Kibana to highlight which devices on the local network are accessing which remote servers, on which ports and using which protocols.</p>
<p>In the next post, I'll examine how to further enhance the information we've extracted from the access messages to make it easier to relate ip address to actual devices on the network and out in the world.</p>



                                </div>
                        </div>
                </div>

                <hr>

                <!-- Footer -->
                <footer>
                        <div class="container">
  <div class="row">
    <div class="col-md-12 text-center">
      <ul class="list-inline text-center">
        <li>
          <a href="https://twitter.com/ibebbs">
            <span class="fa-stack fa-lg">
              <i class="fa fa-circle fa-stack-2x"></i>
              <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
            </span>
          </a>
        </li>
        <li>
          <a href="https://github.com/ibebbs">
            <span class="fa-stack fa-lg">
              <i class="fa fa-circle fa-stack-2x"></i>
              <i class="fa fa-github fa-stack-1x fa-inverse"></i>
            </span>
          </a>
        </li>
        <li>
          <a href="http://stackoverflow.com/users/628821/ibebbs">
            <span class="fa-stack fa-lg">
              <i class="fa fa-circle fa-stack-2x"></i>
              <i class="fa fa-stack-overflow fa-stack-1x fa-inverse"></i>
            </span>
          </a>
        </li>
        <li>
          <a href="https://social.msdn.microsoft.com/profile/ian%20bebbington/">
            <span class="fa-stack fa-lg">
              <i class="fa fa-circle fa-stack-2x"></i>
              <i class="fa fa-windows fa-stack-1x fa-inverse"></i>
            </span>
          </a>
        </li>
      </ul>
      <p class="copyright text-muted">
        Copyright © 2018 by Ian Bebbington. The opinions expressed herein are my own and do not represent those of my employer or any other third-party views in any way. This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/">"Creative Commons Attribution 4.0 International License"</a>
        <br />
        <a href="/feed.rss"><i class="fa fa-rss"></i> RSS Feed</a> | <a href="/feed.atom"><i class="fa fa-rss"></i> Atom Feed</a>
        <br />
        <strong><a href="http://wyam.io">Generated by Wyam</a></strong>
      </p>
    </div>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-70151903-1', 'auto');
      ga('send', 'pageview');

    </script>

    <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'ibebbs'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                    var s = document.createElement('script'); s.async = true;
                    s.type = 'text/javascript';
                    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
                    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
            }());
    </script>
</div>

                </footer>

                
        </body>
</html>
o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-70151903-1', 'auto');
      ga('send', 'pageview');

    </script>
</div>

                </footer>

                
        </body>
</html>
EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'ibebbs'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                    var s = document.createElement('script'); s.async = true;
                    s.type = 'text/javascript';
                    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
                    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
            }());
    </script>
</div>

                </footer>

                
        </body>
</html>
ntsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

                </footer>

                
        </body>
</html>

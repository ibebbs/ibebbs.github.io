
<!DOCTYPE html>
<html lang="en">
        <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>

        <title>Ian Bebbington - A SmartHome... NoT - Part II</title>
        <meta name="description" content="IObservable&lt;Opinion&gt;" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">        

        <link type="application/rss+xml" rel="alternate" title="Ian Bebbington" href="/feed.rss" />
                <link type="application/atom+xml" rel="alternate" title="Ian Bebbington" href="/feed.atom" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">

        <link href="/assets/css/bootstrap.min.css" rel="stylesheet" />
        <link href="/assets/css/highlight.css" rel="stylesheet">
        <link href="/assets/css/clean-blog.css" rel="stylesheet" />
        <link href="/assets/css/master.css" rel="stylesheet" />
        <link href="/assets/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
        <link href="/assets/css/override.css" rel="stylesheet" />


        <meta name="application-name" content="Ian Bebbington" />
        <meta name="msapplication-tooltip" content="Ian Bebbington" />
        <meta name="msapplication-starturl" content="/" />

        <meta property="og:title" content="Ian Bebbington - A SmartHome... NoT - Part II" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="http://ian.bebbs.co.uk/posts/ASmartHome-Part2" />
        <!-- TODO: More social graph meta tags -->

        <script src="/assets/js/jquery.min.js"></script>
        <script src="/assets/js/bootstrap.min.js"></script>     
        <script src="/assets/js/highlight.pack.js"></script>   
        <script src="/assets/js/clean-blog.js"></script>
        <script src="/assets/js/d3.v3.min.js"></script>
        <script src="/assets/js/trianglify.min.js"></script>
        <script src="/assets/js/Please-compressed.js"></script>
        <script src="/assets/js/background-check.min.js"></script>
                
        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
                <script src="/assets/js/html5shiv.js"></script>
                <script src="/assets/js/respond.min.js"></script>
        <![endif]-->
        
        <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-70151903-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-70151903-1');
</script>


        </head>
        <body>
                
                <!-- Navigation -->
                <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
                        <div class="container-fluid">
                                <!-- Brand and toggle get grouped for better mobile display -->
                                <div class="navbar-header page-scroll">
                                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
                                        <span class="sr-only">Toggle navigation</span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        </button>
                                        <a class="navbar-brand" href="/">Ian Bebbington</a>
                                </div>
                        
                                <!-- Collect the nav links, forms, and other content for toggling -->
                                <div class="collapse navbar-collapse" id="navbar-collapse">
                                        <ul class="nav navbar-nav navbar-right">
                                                        <li><a href="/posts">Archive</a></li>
        <li><a href="/tags">Tags</a></li>
        <li><a href="/about">About</a></li>
 
                                        </ul>
                                </div>
                                <!-- /.navbar-collapse -->
                        </div>
                        <!-- /.container -->
                </nav>
                
                <!-- Page Header -->
                <header class="intro-header" id="intro-header">
                        <div class="container">
                                <div class="row">
                                        <div class="col-md-12">

    
<div class="post-heading">
    <h1>A SmartHome... NoT - Part II</h1>
        <h2 class="subheading">Home monitoring and automation without compromising privacy nor security</h2>
    <div class="meta">        
Published on 06 February 2018<br>    </div>
        <div class="tags">
                    <a role="button" href="/tags/Home-Automation" class="btn btn-default btn-xs">Home Automation</a>
                    <a role="button" href="/tags/IoT" class="btn btn-default btn-xs">IoT</a>
                    <a role="button" href="/tags/Node-Red" class="btn btn-default btn-xs">Node-Red</a>
                    <a role="button" href="/tags/NoT" class="btn btn-default btn-xs">NoT</a>
                    <a role="button" href="/tags/OpenHAB" class="btn btn-default btn-xs">OpenHAB</a>
                    <a role="button" href="/tags/Privacy" class="btn btn-default btn-xs">Privacy</a>
                    <a role="button" href="/tags/Xiaomi" class="btn btn-default btn-xs">Xiaomi</a>
        </div>     
</div>
                                        </div>
                                </div>
                        </div>
                </header>
                
                <!-- Main Content -->
                <div class="container">
                        <div class="row">
                                <div id="content" class="col-md-12">
                                        

<p>In <a href="http://ian.bebbs.co.uk/posts/ASmartHome-Part1">part I</a> of this series I described how to use Xiaomi Mi Smart Home devices without compromising your home privacy or security.</p>
<p>And lo, with the <em>sweet, sweet nut</em> of privacy-friendly sensors laid before me, I raised the metaphorical <em>hammer of code</em> like an allegorical Thor about to deliver righteous justice to... and then I stopped. What was I trying to deliver righteous justice to. In fact, what the smeg did I actually want to <em>do</em> with all these things?</p>
<p>So focused had I been on finding a 'how', I hadn't really considered the what or why? Monitoring, sure but there had to be useful things I could automate.</p>
<p>At this point I decided to take a look around at what other people were doing and, almost inevitably, came upon the <a href="https://community.openhab.org/">OpenHAB forums</a>.</p>
<h1 id="openhabian">OpenHABian</h1>
<p>OpenHAB has been around for years and for much of this time has been the <em>go to</em> software for home automation.  Nowadays there a numerous other offerings and OpenHAB has had to rapidly evolve to stay competitive. To this end OpenHAB recently released OpenHAB 2 which, as far as I can tell, is a full rewrite based on <a href="https://www.eclipse.org/smarthome/">Eclipse SmartHome framework</a>.</p>
<p>While <a href="http://www.myopenhab.org/">'cloud based' versions of OpenHAB are available</a> the normal use-case is to deploy a version of OpenHAB on the local network thereby keeping all processing locally too. To facilitate this, they now offer pre-built images of OpenHabian - a distribution for single board computes (i.e. the Raspberry Pi et al) that comes with OpenHAB pre-installed.</p>
<p>Anyway, I was interested in how OpenHAB might have evolved and love trying out new images on the Raspberry Pi (seriously it's like Docker except on real hardware and... well... works) so downloaded <a href="https://github.com/openhab/openhabian/releases">the latest version</a> (somewhat confusing named 'version 1.4' even though it contains OpenHAB 2.2), <a href="https://etcher.io/">etched it</a> to an SD card, put the SD card in a spare RPi3 and booted.</p>
<h2 id="installation">Installation</h2>
<p>Installation of OpenHABian is pretty straight forward, simply insert the newly prepared SD card and power on the Pi. One thing to note however is that the setup of OpenHABian requires internet access to download additional components / updates. As I had added the RPi3 running OpenHABian to my secured subnet, my first install of OpenHABian failed as there was no internet access available. A quick firewall exclusion and restart solved the problem.</p>
<h2 id="paper-ui">Paper UI</h2>
<p>One of the key enhancements in OpenHAB 2 is the introduction of 'Paper UI'. Paper UI is an HTML5 web application which allows a fully graphical setup and administration of <a href="https://docs.openhab.org/configuration/things.html">Things</a> and <a href="https://docs.openhab.org/configuration/items.html">Items</a>. Where previously you'd have to drop into textual configuration of components, Paper UI offers a simplified means of getting your home automation devices known to, and used by, OpenHAB.</p>
<p>Indeed, getting Paper UI to recognise and use my Xiaomi Mi Smart Home devices was simple and can be done as follows:</p>
<ol>
<li><p>Install the <a href="https://docs.openhab.org/addons/bindings/mihome/readme.html">'Xiaomi Mi Smart Home Binding'</a>.</p>
<ul>
<li>From the Paper UI, click the 'Add-ons' menu item on the left</li>
<li>Click the 'Bindings' tab at the top of the page</li>
<li>Search for 'Xiaomi'</li>
<li>Click the 'INSTALL' button to the right of the 'Xiaomi Mi Smart Home Binding'</li>
</ul>
</li>
<li><p>Add the Xiaomi Gateway(s)</p>
<ul>
<li>Once the 'Xiaomi Mi Smart Home Binding' has been installed, any gateways on the current subnet that have 'local network functions' enabled should magically appear in the 'Inbox' and have a notification shown.</li>
<li>For each gateway on the subnet, simply add it as a 'Thing' with a unique name and in an appropriate location. Also don't forget to add the 'developer key' (copied from the Xiami Mi Home app after enabling 'local network functions') so you can issue commands to the gateway.</li>
<li>Each time you add a gateway, the binding will query sub-devices registered with the gateway which will also then be shown in the inbox. These sub-devices can then be added as 'Things' for which you should  remember to set the location so 'Items' linked to the 'Thing' (see below) are displayed correctly.</li>
</ul>
</li>
<li><p>Add 'Items' to be displayed</p>
<ul>
<li>You should now see all your devices in 'Things'. Each one has several 'Channels' which can be 'linked' to an 'Item' by clicking the blue and white circular icon beside it. For most types of 'Channels', the default values displayed in the 'Link Channel' can be left as is.</li>
<li>Each 'Item' linked to a channel is shown on the Control page with Locations seperated on to discrete tabs.</li>
</ul>
</li>
</ol>
<p>Once all your Xiaomi devices have been added as 'Things' and their respective 'Channels' linked to 'Items' you should end up with something like this in the 'Control' page:</p>
<img src="/Content/posts/OpenHAB - Paper UI - Configured.png" alt="OpenHAB - Paper UI - Configured" class="img-responsive" style="margin-left: auto; margin-right: auto; margin-top: 4px; margin-bottom: 4px">
<p>So far so good. Now what?</p>
<p>Well, turns out not a lot. After getting your devices added to OpenHABian, you have to move into textual configuration if you want to actually perform any automation via interaction between devices.</p>
<p>&quot;Oh&quot;, I thought, &quot;That was a waste of time then&quot;.</p>
<h2 id="node-red">Node-RED</h2>
<p>On a whim, I decided to SSH into OpenHABian and play with the <a href="https://docs.openhab.org/installation/openhabian.html#openhabian-config">OpenHABian Configuration Tool</a>. Most of the options were fairly straight forward and unexciting until I got to the <a href="https://docs.openhab.org/installation/openhabian.html#optional-components">Optional Components</a> menu. Here a couple of items caught my eye, particularly the option to install Node-RED along side OpenHAB.</p>
<p>I'd heard of <a href="https://nodered.org/">Node-RED</a> previously but had never tried it. As I was about to junk the install of OpenHABian anyway, I decided I'd have a play... and this is where the magic happened.</p>
<p>For others who have not used Node-RED, it is a Node.js app designed for &quot;wiring together hardware devices, APIs and online services in new and interesting ways&quot;. It has an amazingly simple yet ludicrously brilliant UI which makes experimentation with it's various 'nodes' extremely quick and easy. Moreover, the installation on OpenHABian comes pre-installed with nodes to interact with 'Items' in OpenHAB.</p>
<p>Despite, never having used Node-RED before, in just a few minutes I had the following flow deployed and running:</p>
<img src="/Content/posts/Node-RED - First Flow.png" alt="First Node-RED flow" class="img-responsive" style="margin-left: auto; margin-right: auto; margin-top: 4px; margin-bottom: 4px">
<p>Which does the following:</p>
<ol>
<li>Uses an <code>openhab2-in</code> node to listen to changes to the <code>OfficeDoorSensor_OpenStatus</code> value.</li>
<li>Uses a <code>switch</code> node to compare the status value to 'OPEN' or 'CLOSED' and emit the message to the appropriate port.</li>
<li>If the door has been opened:
<ul>
<li>Use a <code>openhab2-out</code> node to issue a 'ON' <code>ItemCommand</code> to the <code>OfficeGateway_Brightness</code> channel (i.e. turn the light in the Xiami Mi Smart Gateway on).</li>
<li>Wait five seconds then use a <code>openhab2-out</code> node to issue a 'OFF' <code>ItemCommand</code> to the <code>OfficeGateway_Brightness</code> channel (i.e. turn the light in the Xiami Mi Smart Gateway off).</li>
</ul>
</li>
<li>If the door has been closed then use a <code>openhab2-out</code> node to issue a 'OFF' <code>ItemCommand</code> to the <code>OfficeGateway_Brightness</code> channel (i.e. turn the light in the Xiami Mi Smart Gateway off).</li>
</ol>
<p>Ok, the use case is fairly simple but wow, what an incredibly level of integration between disparate sensors / lights with just five nodes, a few connections and no bespoke code what-so-ever.</p>
<p>I was hooked.</p>
<p>Playing with Node-RED inspired me to start brain-storming potential use-cases and they soon started coming thick and fast. Broadly the use-cases fell into three main categories:</p>
<ol>
<li>Utility - mitigate small frustrations around the house</li>
<li>Security - enhance home security</li>
<li>Efficiency - reduce home power consumption</li>
</ol>
<p>However, one use case I came up with fell into all three of these categories <strong>and</strong> a logical progression from the above flow.</p>
<h1 id="a-use-case-at-last">A use case at last!</h1>
<p>Our new 'forever home' has a built in double garage. While the doors on the garage are in pretty good condition, the locks are nothing special and present an obvious security weak spot. Indeed, we use the garage doors every day as it's a very convenient way into the house which increases the likelihood we'll forget to close the doors properly.</p>
<p>Furthermore, the flurescent lights in the garage are old and take an age to turn on. As we need to go through the garage to get to the utility room and can't see the way to the utility room until the light is on, we tended to simply turn them on at the beginning of the day and turn them off before going to bed each night, thereby consuming way more energy than necessary.</p>
<p>Understanding this, I used an additional gateway in the garage, coupled with sensors on each of the doors (garage door, kitchen door, utility room door) and an easily controllable <a href="https://www.amazon.co.uk/gp/product/B077HLQMBD">IP camera</a> to put together the following flow:</p>
<img src="/Content/posts/Node-RED - Garage.png" alt="Node-RED garage flow" class="img-responsive" style="margin-left: auto; margin-right: auto; margin-top: 4px; margin-bottom: 4px">
<p>This does a couple of things:</p>
<ol>
<li><p>Turns on the light in the gateway whenever any of the doors open</p>
<p>The light in the gateway is more than enough to light the way to the utility room which addresses the utility aspect of the use-case as we no longer need to wait for the garage light to come on. Furthermore, three minutes after the door was opened (regardless of whether it's been closed again), the light in the gateway is turned off. This is normally long enough for us to do whatever we needed in the garage and addresses the efficiency aspect of the use-case as we no longer leave a light on all day.</p>
</li>
<li><p>Turns the IP Camera to look at the opened door and takes a snapshot</p>
<p>The IP camera I've used has a useful feature whereby it can record several Pan/Tilt positions which it can then return to using a single command. I use this feature to point the camera at the door which has just been opened and use a further command to take a snapshot image of what it sees. This addresses the security aspect of the use case by ensuring video surveilance coverage of activity within the garage.<br />
<em>Ultimately I intend to upload this image to a cloud storage provider and send a notification to my phone if this happens within certain time constraints but this has yet to be implemented.</em></p>
</li>
</ol>
<h1 id="moving-forward">Moving forward</h1>
<p>As you can see, the combination of Xiaomi Mi Smart devices, OpenHAB[ian] and Node-RED is extremely potent. Without writing any code (compiled, intepreted or DSL), I'm able to orchestrate some very advanced interactions between sensors, actuators and other services.</p>
<p>In the next post, I'll discuss how I've developed this platform even further into a full, voice activated, digital assistant while <em>still</em> maintaining privacy and security.</p>



                                </div>
                        </div>
                </div>
                
                <hr>
                
                <!-- Footer -->
                <footer>
                        <div class="container">
        <div class="row">
                <div class="col-md-12">
                        <ul class="list-inline text-center">
    <li>
        <a href="https://twitter.com/ibebbs">
            <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
            </span>
        </a>
    </li>
    <li>
        <a href="https://www.linkedin.com/in/ianbebbington/">
            <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
            </span>
        </a>
    </li>
    <li />
    <li>
        <a href="https://github.com/ibebbs">
            <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
            </span>
        </a>
    </li>
    <li>
        <a href="https://stackoverflow.com/users/628821/ibebbs">
            <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-stack-overflow fa-stack-1x fa-inverse"></i>
            </span>
        </a>
    </li>
</ul>
                        <br />
                        <ul class="list-inline text-center">
                                <li>                                
                                        <!-- Buy Me A Coffee Button -->
                                        <style>.bmc-button img{width: 27px !important;margin-bottom: 1px !important;box-shadow: none !important;border: none !important;vertical-align: middle !important;}.bmc-button{line-height: 36px !important;height:37px !important;text-decoration: none !important;display:inline-flex !important;color:#FFFFFF !important;background-color:#FF813F !important;border-radius: 3px !important;border: 1px solid transparent !important;padding: 1px 9px !important;font-size: 22px !important;letter-spacing: 0.6px !important;box-shadow: 0px 1px 2px rgba(190, 190, 190, 0.5) !important;-webkit-box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;margin: 0 auto !important;font-family:'Cookie', cursive !important;-webkit-box-sizing: border-box !important;box-sizing: border-box !important;-o-transition: 0.3s all linear !important;-webkit-transition: 0.3s all linear !important;-moz-transition: 0.3s all linear !important;-ms-transition: 0.3s all linear !important;transition: 0.3s all linear !important;}.bmc-button:hover, .bmc-button:active, .bmc-button:focus {-webkit-box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;text-decoration: none !important;box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;opacity: 0.85 !important;color:#FFFFFF !important;}</style><link href="https://fonts.googleapis.com/css?family=Cookie" rel="stylesheet"><a class="bmc-button" target="_blank" href="https://www.buymeacoffee.com/BQKYdkpaN"><img src="https://bmc-cdn.nyc3.digitaloceanspaces.com/BMC-button-images/BMC-btn-logo.svg" alt="Buy me a coffee"><span style="margin-left:5px">Buy me a coffee</span></a>
                                </li>
                        </ul>
                        <p class="copyright text-muted">
                                Copyright © 2019. The opinions expressed herein are my own and do not represent those of my employer or any other third-party views in any way. This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/" rel="license">Creative Commons Attribution 4.0 International License</a>.
                                <br />
                                <a href="/feed.rss"><i class="fa fa-rss"></i> RSS Feed</a> | <a href="/feed.atom"><i class="fa fa-rss"></i> Atom Feed</a>
                                <br />
                                <strong><a href="https://wyam.io">Generated by Wyam</a></strong>
                                <br />
                        <br />
                        </p>
                </div>
        </div>
</div>
                </footer> 

                
                <script>hljs.initHighlightingOnLoad();</script>

                        <script type="text/javascript">                
                                // Header background                        
                                var colors = Please.make_color({
                                        colors_returned: 3,
                                        saturation: .6
                                });
                                var t = new Trianglify({
                                        x_gradient: colors,
                                        y_gradient: ["#FFFFFF"]
                                });
                                var header = document.getElementById("intro-header");
                                var pattern = t.generate(header.clientWidth, header.clientHeight);
                                header.setAttribute('style', 'background-image: ' + pattern.dataUrl);                        
                        </script>

                <script>
                        BackgroundCheck.init({
                                targets: '.intro-header,.navbar',
                                images: '.intro-header'
                        });
                </script>
        </body>
</html>

